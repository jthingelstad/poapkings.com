# poapkings.com

Static multi-page site for the POAP KINGS Clash Royale clan, built with [Eleventy (11ty)](https://www.11ty.dev/).

## Project layout
- `src/`: Site source files (templates, static assets, data).
  - `src/_includes/base.njk`: Shared layout (header, nav, footer, scripts).
  - `src/_includes/clan-stats.njk`: Shared clan statistics grid (used by homepage and roster).
  - `src/_data/site.json`: Site-wide data (url, join URL, Tinylytics ID, clan tag, tagline, min trophies, league, status).
  - `src/_data/roster.json`: Public roster data (auto-generated by sync script). Rendered at build time.
  - `src/_data/vault.json`: POAP vault data. Rendered at build time.
  - `src/index.njk`: Home page (`/`).
  - `src/roster.njk`: Roster page (`/roster/`).
  - `src/vault.njk`: Vault page (`/vault/`).
  - `src/faq.njk`: FAQ page (`/faq/`).
  - `src/members.njk`: Members page (`/members/`).
  - `src/setup.njk`: Clan Setup page (`/members/setup/`).
  - `src/404.njk`: Custom 404 page (standalone layout).
  - `src/styles.css`: All styling.
  - `src/app.js`: Client-side script for roster search and vault type filtering.
  - `src/members-promo.js`: Client-side script for promote-the-clan copy/send buttons.
  - `src/sitemap.njk`: 11ty-generated sitemap template (outputs `/sitemap.xml`).
  - `src/assets/`: Static assets (logo, icons, font, vault images).
  - `src/CNAME`: Custom domain for GitHub Pages.
  - `src/robots.txt`: SEO file.
- `roster-extra.json`: Manually-maintained custom member data (POAP wallets, profile URLs, notes, join dates). Keyed by player tag (without `#`). Not served.
- `scripts/sync-roster.py`: Python 3 script that fetches the Clash Royale API and merges with `roster-extra.json` to produce `src/_data/roster.json`.
- `.env`: Local API key storage (gitignored). Contains `CR_API_KEY=...`.
- `eleventy.config.js`: 11ty configuration (passthrough copies, template filters, input/output dirs).
- `package.json`: Node.js project with 11ty dependency.
- `.github/workflows/deploy.yml`: GitHub Actions workflow to build and deploy to GitHub Pages.

## Build
```bash
npm install       # Install dependencies (first time)
npm run build     # Build site to _site/
npm start         # Dev server with live reload
```

## Deploy
Pushing to `main` triggers the GitHub Actions workflow which:
1. Installs dependencies (`npm ci`)
2. Builds the site (`npm run build`)
3. Deploys `_site/` to GitHub Pages

**Important:** In the GitHub repo settings, Pages source must be set to **GitHub Actions** (not "Deploy from a branch").

## Key behaviors
- Roster and vault content are rendered at build time from `_data/` JSON files — no client-side fetch.
- `app.js` provides client-side search filtering (roster) and type filtering (vault) on pre-rendered HTML.
- Clan stats are computed at build time via the `clanStats` filter and shared across pages via `clan-stats.njk`.
- Each roster row includes a `data-search` attribute for instant search filtering.
- Each vault card includes a `data-type` attribute for type filtering.
- Player tags can be with or without `#`; the templates normalize them.
- Pages share a base layout (`base.njk`) with configurable nav, footer, and script includes.
- `base.njk` includes OG/Twitter/canonical meta tags using `site.url` for absolute URLs.
- CSS and JS references use the `bust` filter for cache-busting via content hashes.
- Sitemap is generated by 11ty from `collections.all`; pages with `excludeFromSitemap: true` are excluded.

## Adding a page
1. Create `src/<name>.njk` with front matter referencing `layout: base.njk`.
2. Set `permalink` to the desired URL path (e.g. `/about/`).
3. Set `title`, `description`, `navActive` (home/roster/vault/members or omit), and optional flags (`appJs`, `supercellDisclaimer`, `mainId`, `extraScripts`, `excludeFromSitemap`).
4. Page content goes below the front matter — it renders inside `<main>` in the base layout.

## Template filters
Custom filters defined in `eleventy.config.js`:
- `formatDate` / `formatLongDate`: Format ISO date strings for display.
- `formatNumber`: Number with locale-aware commas.
- `royaleApiUrl`: Build RoyaleAPI player URL from a tag.
- `safeUrl`: Validate and sanitize a URL.
- `poapCollectionUrl`: Build POAP scan URL from a wallet address.
- `roleClass` / `typeClass`: CSS class strings for role and type pills.
- `groupByRole`: Group and sort members into Leaders/Elders/Members.
- `sortVault`: Sort POAPs with upcoming items last.
- `clanStats`: Compute aggregate clan statistics from member data.
- `searchText`: Build lowercase search text for a member.
- `bust`: Append content-hash query string for cache-busting static assets.

## Roster schema
`src/_data/roster.json` is auto-generated by the sync script and contains:

```json
{
  "updated": "YYYY-MM-DDTHH:MM:SSZ",
  "members": [
    {
      "name": "Display Name",
      "tag": "20JJJ2CCRU",
      "role": "Leader",
      "exp_level": 15,
      "trophies": 6200,
      "arena": "Champion",
      "clan_rank": 1,
      "donations": 42,
      "donations_received": 10,
      "last_seen": "20260215T120000.000Z",
      "note": "Founder",
      "profile_url": "https://example.com",
      "address": "name.eth",
      "date_joined": "2025-12-01"
    }
  ]
}
```

API-sourced fields: `name`, `tag`, `role`, `exp_level`, `trophies`, `arena`, `clan_rank`, `donations`, `donations_received`, `last_seen`.
Custom fields (from `roster-extra.json`): `note`, `profile_url`, `address`, `date_joined`.

## Updating the roster
1. Run `python3 scripts/sync-roster.py` to fetch from Clash Royale API and write `src/_data/roster.json`.
2. Edit `roster-extra.json` for custom member data (POAP wallets, profile URLs, notes, join dates). Do **not** hand-edit `src/_data/roster.json`.
3. New members not in `roster-extra.json` get `date_joined` set to today automatically.
4. API key is stored in `.env` (gitignored) as `CR_API_KEY=...`.
5. If the API key fails with an IP error, the script prints the rejected IP to whitelist at developer.clashroyale.com.

```bash
python3 scripts/sync-roster.py
git add src/_data/roster.json && git commit -m "Sync roster" && git push
```

## Local preview
```bash
npm start
```
Opens a dev server at `http://localhost:8080` with live reload.

## Notes
- The 404 page uses its own standalone layout (no shared nav/footer).
- `roster-extra.json` lives at the project root, not in `src/`, since it is not served.
